{% extends "base.html" %}

{% block title %}Statistics - BehaviorGuard {% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="h2 mb-4">
            <i data-feather="bar-chart-2" class="me-2"></i>
            Analysis Statistics
        </h1>
    </div>
</div>

<!-- Statistics Cards -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card bg-primary text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-title">Total Jobs</h6>
                        <h2 class="mb-0">{{ stats.total_jobs }}</h2>
                    </div>
                    <i data-feather="activity" width="32" height="32"></i>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card bg-success text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-title">Completed</h6>
                        <h2 class="mb-0">{{ stats.completed_jobs }}</h2>
                        <small>{{ "%.1f"|format(stats.success_rate) }}% success rate</small>
                    </div>
                    <i data-feather="check-circle" width="32" height="32"></i>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card bg-warning text-dark">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-title">Pending</h6>
                        <h2 class="mb-0">{{ stats.pending_jobs }}</h2>
                        <small>In progress</small>
                    </div>
                    <i data-feather="clock" width="32" height="32"></i>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card bg-danger text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-title">Failed</h6>
                        <h2 class="mb-0">{{ stats.failed_jobs }}</h2>
                        <small>Errors occurred</small>
                    </div>
                    <i data-feather="x-circle" width="32" height="32"></i>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Charts Row -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i data-feather="pie-chart" class="me-2"></i>
                    Job Status Distribution
                </h5>
            </div>
            <div class="card-body">
                <canvas id="statusChart" width="400" height="200"></canvas>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i data-feather="trending-up" class="me-2"></i>
                    Success Rate
                </h5>
            </div>
            <div class="card-body">
                <div class="text-center">
                    <div class="display-4 mb-3">{{ "%.1f"|format(stats.success_rate) }}%</div>
                    <div class="progress" style="height: 20px;">
                        <div class="progress-bar bg-success" 
                             role="progressbar" 
                             style="width: {{ stats.success_rate }}%"
                             aria-valuenow="{{ stats.success_rate }}" 
                             aria-valuemin="0" 
                             aria-valuemax="100">
                        </div>
                    </div>
                    <p class="text-muted mt-3">
                        {{ stats.completed_jobs }} out of {{ stats.total_jobs }} jobs completed successfully
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Recent Activity -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i data-feather="clock" class="me-2"></i>
                    Recent Activity
                </h5>
            </div>
            <div class="card-body">
                {% if stats.recent_jobs %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Job ID</th>
                                    <th>Filename</th>
                                    <th>Status</th>
                                    <th>Created</th>
                                    <th>Duration</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for job in stats.recent_jobs %}
                                    <tr>
                                        <td>
                                            <a href="{{ url_for('analysis.view_job', job_id=job.id) }}" class="text-decoration-none">
                                                #{{ job.id }}
                                            </a>
                                        </td>
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <i data-feather="file" class="me-2 text-muted" width="16" height="16"></i>
                                                <span class="text-truncate" style="max-width: 200px;">{{ job.filename }}</span>
                                            </div>
                                        </td>
                                        <td>
                                            <span class="badge bg-{{ 'success' if job.status.value == 'completed' else 'warning' if job.status.value in ['pending', 'analyzing'] else 'danger' if job.status.value == 'failed' else 'info' }}">
                                                {{ job.status.value.replace('_', ' ').title() }}
                                            </span>
                                        </td>
                                        <td class="text-muted small">
                                            {{ job.created_at.strftime('%Y-%m-%d %H:%M') }}
                                        </td>
                                        <td class="text-muted small">
                                            {% set duration = (job.updated_at - job.created_at).total_seconds() %}
                                            {% if duration < 60 %}
                                                {{ "%.0f"|format(duration) }}s
                                            {% elif duration < 3600 %}
                                                {{ "%.0f"|format(duration / 60) }}m
                                            {% else %}
                                                {{ "%.1f"|format(duration / 3600) }}h
                                            {% endif %}
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="text-center py-4">
                        <i data-feather="inbox" class="text-muted mb-3" width="48" height="48"></i>
                        <h6 class="text-muted">No recent activity</h6>
                        <p class="text-muted">Start analyzing files to see activity here</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block extra_scripts %}
<script>
// Status Distribution Chart
const ctx = document.getElementById('statusChart').getContext('2d');
const statusChart = new Chart(ctx, {
    type: 'doughnut',
    data: {
        labels: ['Completed', 'Pending', 'Failed'],
        datasets: [{
            data: [{{ stats.completed_jobs }}, {{ stats.pending_jobs }}, {{ stats.failed_jobs }}],
            backgroundColor: [
                'rgba(25, 135, 84, 0.8)',   // Success green
                'rgba(255, 193, 7, 0.8)',   // Warning yellow
                'rgba(220, 53, 69, 0.8)'    // Danger red
            ],
            borderColor: [
                'rgba(25, 135, 84, 1)',
                'rgba(255, 193, 7, 1)',
                'rgba(220, 53, 69, 1)'
            ],
            borderWidth: 2
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'bottom',
                labels: {
                    padding: 20,
                    color: '#6c757d'
                }
            }
        }
    }
});

// Auto-refresh stats every 60 seconds
setInterval(function() {
    fetch('/analysis/api/stats')
        .then(response => response.json())
        .then(data => {
            // Update chart data
            statusChart.data.datasets[0].data = [data.completed_jobs, data.pending_jobs, data.failed_jobs];
            statusChart.update();
            
            // Update cards
            document.querySelector('.bg-primary .card-body h2').textContent = data.total_jobs;
            document.querySelector('.bg-success .card-body h2').textContent = data.completed_jobs;
            document.querySelector('.bg-success .card-body small').textContent = data.success_rate.toFixed(1) + '% success rate';
            document.querySelector('.bg-warning .card-body h2').textContent = data.pending_jobs;
            document.querySelector('.bg-danger .card-body h2').textContent = data.failed_jobs;
            
            // Update success rate display
            document.querySelector('.display-4').textContent = data.success_rate.toFixed(1) + '%';
            document.querySelector('.progress-bar').style.width = data.success_rate + '%';
            document.querySelector('.progress-bar').setAttribute('aria-valuenow', data.success_rate);
        })
        .catch(error => console.log('Error refreshing stats:', error));
}, 60000);
</script>
{% endblock %}
