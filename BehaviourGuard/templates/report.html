{% extends "base.html" %}

{% block title %}Analysis Report #{{ job.id }} - BehaviorGuard {% endblock %}

{% block extra_head %}
<style>
.report-section {
    margin-bottom: 2rem;
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 0.5rem;
}

.report-header {
    background: linear-gradient(135deg, var(--bs-primary), var(--bs-info));
    color: white;
    padding: 1.5rem;
    border-radius: 0.5rem 0.5rem 0 0;
}

.threat-indicator {
    padding: 1rem;
    border-radius: 0.5rem;
    margin-bottom: 1rem;
    border-left: 4px solid;
}

.threat-high {
    background-color: rgba(220, 53, 69, 0.1);
    border-left-color: var(--bs-danger);
}

.threat-medium {
    background-color: rgba(255, 193, 7, 0.1);
    border-left-color: var(--bs-warning);
}

.threat-low {
    background-color: rgba(25, 135, 84, 0.1);
    border-left-color: var(--bs-success);
}

.timeline {
    position: relative;
    padding-left: 2rem;
}

.timeline::before {
    content: '';
    position: absolute;
    left: 1rem;
    top: 0;
    bottom: 0;
    width: 2px;
    background: linear-gradient(to bottom, var(--bs-primary), var(--bs-success));
}

.timeline-item {
    position: relative;
    margin-bottom: 1.5rem;
    background-color: rgba(255, 255, 255, 0.05);
    padding: 1rem;
    border-radius: 0.5rem;
    border-left: 3px solid var(--bs-primary);
}

.timeline-item::before {
    content: '';
    position: absolute;
    left: -2.25rem;
    top: 1rem;
    width: 1rem;
    height: 1rem;
    border-radius: 50%;
    background-color: var(--bs-primary);
    border: 3px solid var(--bs-dark);
}

.ioc-category {
    margin-bottom: 1.5rem;
}

.ioc-items {
    max-height: 300px;
    overflow-y: auto;
    background-color: rgba(0, 0, 0, 0.2);
    border-radius: 0.375rem;
    padding: 1rem;
}

.ioc-item {
    background-color: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 0.25rem;
    padding: 0.75rem;
    margin-bottom: 0.75rem;
    font-family: 'Courier New', monospace;
    font-size: 0.875rem;
    word-break: break-all;
    position: relative;
}

.ioc-item:last-child {
    margin-bottom: 0;
}

.copy-btn {
    position: absolute;
    top: 0.5rem;
    right: 0.5rem;
    background: rgba(255, 255, 255, 0.1);
    border: none;
    color: #fff;
    padding: 0.25rem 0.5rem;
    border-radius: 0.25rem;
    font-size: 0.75rem;
}

.mitre-matrix {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-bottom: 1.5rem;
}

.mitre-technique {
    background-color: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 0.375rem;
    padding: 1rem;
    text-align: center;
}

.network-flow {
    background-color: rgba(0, 0, 0, 0.2);
    border-radius: 0.5rem;
    padding: 1.5rem;
    margin-bottom: 1rem;
}

.severity-critical { color: #dc3545; }
.severity-high { color: #fd7e14; }
.severity-medium { color: #ffc107; }
.severity-low { color: #28a745; }
.severity-info { color: #17a2b8; }

@media print {
    .no-print { display: none !important; }
    .report-section { page-break-inside: avoid; }
    .card { border: 1px solid #000 !important; }
}
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <!-- Report Header -->
        <div class="report-section">
            <div class="report-header text-center">
                <h1 class="display-6 mb-3">
                    <i data-feather="shield" class="me-3"></i>
                    Behavioral Malware Analysis Report
                </h1>
                <p class="lead mb-0">Comprehensive Security Assessment</p>
            </div>
            
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h5>File Information</h5>
                        <table class="table table-borderless">
                            <tr>
                                <td><strong>Filename:</strong></td>
                                <td>{{ job.filename }}</td>
                            </tr>
                            <tr>
                                <td><strong>SHA256 Hash:</strong></td>
                                <td><code class="small">{{ job.file_hash }}</code></td>
                            </tr>
                            <tr>
                                <td><strong>File Size:</strong></td>
                                <td>{{ "{:,}".format(job.file_size) }} bytes</td>
                            </tr>
                            <tr>
                                <td><strong>Analysis Date:</strong></td>
                                <td>{{ job.created_at.strftime('%Y-%m-%d %H:%M:%S UTC') }}</td>
                            </tr>
                        </table>
                    </div>
                    
                    <div class="col-md-6">
                        <h5>Analysis Summary</h5>
                        {% if sandbox_report %}
                            {% set threat_level = sandbox_report.get('threat_level', 'Unknown').lower() %}
                            <div class="threat-indicator threat-{{ 'high' if threat_level in ['high', 'malicious'] else 'medium' if threat_level in ['medium', 'suspicious'] else 'low' }}">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="mb-1">Threat Level</h6>
                                        <span class="badge bg-{{ 'danger' if threat_level in ['high', 'malicious'] else 'warning' if threat_level in ['medium', 'suspicious'] else 'success' }}">
                                            {{ sandbox_report.get('threat_level', 'Unknown').title() }}
                                        </span>
                                    </div>
                                    <div>
                                        <i data-feather="{{ 'alert-triangle' if threat_level in ['high', 'malicious'] else 'alert-circle' if threat_level in ['medium', 'suspicious'] else 'check-circle' }}" 
                                           class="severity-{{ 'critical' if threat_level in ['high', 'malicious'] else 'medium' if threat_level in ['medium', 'suspicious'] else 'low' }}" 
                                           width="32" height="32"></i>
                                    </div>
                                </div>
                                <p class="mb-0 mt-2 small">
                                    Verdict: <strong>{{ sandbox_report.get('verdict', 'Unknown').title() }}</strong>
                                </p>
                            </div>
                        {% else %}
                            <div class="alert alert-warning">
                                <i data-feather="info" class="me-2"></i>
                                Sandbox analysis not available
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Executive Summary -->
        <div class="report-section">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="card-title mb-0">
                        <i data-feather="file-text" class="me-2"></i>
                        Executive Summary
                    </h5>
                </div>
                <div class="card-body">
                    {% if sandbox_report %}
                        <div class="row">
                            <div class="col-md-8">
                                <h6>Key Findings</h6>
                                <ul class="list-unstyled">
                                    {% if sandbox_report.get('network') %}
                                        <li class="mb-2">
                                            <i data-feather="wifi" class="text-warning me-2" width="16" height="16"></i>
                                            <strong>Network Activity:</strong> Suspicious network communications detected
                                        </li>
                                    {% endif %}
                                    {% if sandbox_report.get('filesystem') %}
                                        <li class="mb-2">
                                            <i data-feather="hard-drive" class="text-info me-2" width="16" height="16"></i>
                                            <strong>File System:</strong> File modifications and system changes observed
                                        </li>
                                    {% endif %}
                                    {% if sandbox_report.get('registry') %}
                                        <li class="mb-2">
                                            <i data-feather="settings" class="text-primary me-2" width="16" height="16"></i>
                                            <strong>Registry:</strong> System registry modifications detected
                                        </li>
                                    {% endif %}
                                    {% if sandbox_report.get('processes') %}
                                        <li class="mb-2">
                                            <i data-feather="cpu" class="text-danger me-2" width="16" height="16"></i>
                                            <strong>Process Activity:</strong> Suspicious process behavior identified
                                        </li>
                                    {% endif %}
                                </ul>
                            </div>
                            
                            <div class="col-md-4">
                                <h6>Malware Families</h6>
                                {% if sandbox_report.get('classification_tags') %}
                                    {% for tag in sandbox_report.classification_tags[:5] %}
                                        <span class="badge malware-family me-2 mb-2">{{ tag }}</span>
                                    {% endfor %}
                                {% else %}
                                    <p class="text-muted">None identified</p>
                                {% endif %}
                            </div>
                        </div>
                        
                        <hr>
                        
                        <div class="alert alert-{{ 'danger' if sandbox_report.get('verdict') == 'malicious' else 'warning' if sandbox_report.get('verdict') == 'suspicious' else 'info' }}">
                            <h6 class="alert-heading">
                                <i data-feather="shield" class="me-2"></i>
                                Security Recommendation
                            </h6>
                            {% if sandbox_report.get('verdict') == 'malicious' %}
                                <p class="mb-0">This file exhibits <strong>malicious behavior</strong> and should be treated as a confirmed threat. Immediate containment and remediation actions are recommended.</p>
                            {% elif sandbox_report.get('verdict') == 'suspicious' %}
                                <p class="mb-0">This file shows <strong>suspicious characteristics</strong> that warrant further investigation. Consider implementing additional monitoring and analysis.</p>
                            {% else %}
                                <p class="mb-0">Analysis results are inconclusive. Further investigation may be required to determine the file's intent and safety.</p>
                            {% endif %}
                        </div>
                    {% else %}
                        <div class="alert alert-warning">
                            <i data-feather="info" class="me-2"></i>
                            Executive summary unavailable due to incomplete analysis data.
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- MITRE ATT&CK Analysis -->
        {% if sandbox_report and sandbox_report.get('mitre_attcks') %}
            <div class="report-section">
                <div class="card">
                    <div class="card-header bg-danger text-white">
                        <h5 class="card-title mb-0">
                            <i data-feather="target" class="me-2"></i>
                            MITRE ATT&CK Techniques
                        </h5>
                    </div>
                    <div class="card-body">
                        <p class="text-muted mb-3">
                            The following MITRE ATT&CK techniques were identified during behavioral analysis:
                        </p>
                        
                        <div class="mitre-matrix">
                            {% for attack in sandbox_report.mitre_attcks[:12] %}
                                <div class="mitre-technique">
                                    <h6 class="text-danger">{{ attack.get('technique', 'Unknown') }}</h6>
                                    <p class="small text-muted mb-2">{{ attack.get('tactic', 'Unknown Tactic') }}</p>
                                    <p class="small mb-0">{{ attack.get('description', 'No description available')[:100] }}{% if attack.get('description', '')|length > 100 %}...{% endif %}</p>
                                </div>
                            {% endfor %}
                        </div>
                        
                        {% if sandbox_report.mitre_attcks|length > 12 %}
                            <div class="text-center">
                                <small class="text-muted">... and {{ sandbox_report.mitre_attcks|length - 12 }} more techniques</small>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        {% endif %}

        <!-- Network Analysis -->
        {% if network_analysis and not network_analysis.get('note') %}
            <div class="report-section">
                <div class="card">
                    <div class="card-header bg-info text-white">
                        <h5 class="card-title mb-0">
                            <i data-feather="wifi" class="me-2"></i>
                            Network Communication Analysis
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <h6>Traffic Statistics</h6>
                                <div class="table-responsive">
                                    <table class="table table-sm">
                                        <tr>
                                            <td>Total Packets:</td>
                                            <td><span class="badge bg-primary">{{ network_analysis.get('packet_count', 0) }}</span></td>
                                        </tr>
                                        <tr>
                                            <td>DNS Queries:</td>
                                            <td><span class="badge bg-info">{{ network_analysis.get('dns_queries', [])|length }}</span></td>
                                        </tr>
                                        <tr>
                                            <td>HTTP Requests:</td>
                                            <td><span class="badge bg-warning">{{ network_analysis.get('http_requests', [])|length }}</span></td>
                                        </tr>
                                        <tr>
                                            <td>TCP Connections:</td>
                                            <td><span class="badge bg-success">{{ network_analysis.get('conversations', [])|length }}</span></td>
                                        </tr>
                                    </table>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <h6>Protocol Distribution</h6>
                                {% if network_analysis.get('protocols') %}
                                    {% for protocol, count in network_analysis.protocols.items() %}
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <span>{{ protocol }}</span>
                                            <div>
                                                <span class="badge bg-secondary">{{ count }}</span>
                                                <div class="progress" style="width: 100px; height: 6px;">
                                                    <div class="progress-bar" style="width: {{ (count / network_analysis.protocols.values()|list|max * 100)|round }}%"></div>
                                                </div>
                                            </div>
                                        </div>
                                    {% endfor %}
                                {% else %}
                                    <p class="text-muted">No protocol data available</p>
                                {% endif %}
                            </div>
                        </div>
                        
                        {% if network_analysis.get('suspicious_activity') %}
                            <h6 class="text-warning">
                                <i data-feather="alert-triangle" class="me-2"></i>
                                Suspicious Network Activities
                            </h6>
                            <div class="network-flow">
                                {% for activity in network_analysis.suspicious_activity %}
                                    <div class="alert alert-warning py-2 mb-2">
                                        <i data-feather="wifi" class="me-2" width="16" height="16"></i>
                                        {{ activity.description if activity is mapping else activity }}
                                    </div>
                                {% endfor %}
                            </div>
                        {% endif %}
                        
                        {% if network_analysis.get('dns_queries') %}
                            <h6>DNS Query Analysis</h6>
                            <div class="network-flow">
                                <div class="row">
                                    {% for query in network_analysis.dns_queries[:10] %}
                                        <div class="col-md-6 mb-2">
                                            <code class="small">{{ query.domain if query is mapping else query }}</code>
                                        </div>
                                    {% endfor %}
                                </div>
                                {% if network_analysis.dns_queries|length > 10 %}
                                    <small class="text-muted">... and {{ network_analysis.dns_queries|length - 10 }} more queries</small>
                                {% endif %}
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        {% endif %}

        <!-- IOCs Section -->
        {% if iocs %}
            <div class="report-section">
                <div class="card">
                    <div class="card-header bg-warning text-dark">
                        <h5 class="card-title mb-0">
                            <i data-feather="target" class="me-2"></i>
                            Indicators of Compromise (IOCs)
                        </h5>
                    </div>
                    <div class="card-body">
                        <p class="text-muted mb-4">
                            The following indicators of compromise were extracted from the analysis. These can be used for threat hunting and detection rules.
                        </p>
                        
                        <div class="row">
                            {% for ioc_type, ioc_list in iocs.items() %}
                                {% if ioc_list %}
                                    <div class="col-md-6 ioc-category">
                                        <h6 class="text-warning">
                                            <i data-feather="{{ 'globe' if ioc_type in ['domains', 'urls'] else 'server' if ioc_type == 'ips' else 'file' if ioc_type == 'file_hashes' else 'settings' if ioc_type == 'registry_keys' else 'folder' if ioc_type == 'file_paths' else 'lock' }}" class="me-2" width="16" height="16"></i>
                                            {{ ioc_type.replace('_', ' ').title() }} ({{ ioc_list|length }})
                                        </h6>
                                        
                                        <div class="ioc-items">
                                            {% for ioc in ioc_list[:15] %}
                                                <div class="ioc-item">
                                                    <button class="copy-btn" onclick="navigator.clipboard.writeText('{{ ioc }}');" title="Copy to clipboard">
                                                        <i data-feather="copy" width="12" height="12"></i>
                                                    </button>
                                                    {{ ioc }}
                                                </div>
                                            {% endfor %}
                                            
                                            {% if ioc_list|length > 15 %}
                                                <div class="text-center">
                                                    <small class="text-muted">... and {{ ioc_list|length - 15 }} more indicators</small>
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                {% endif %}
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        {% endif %}

        <!-- YARA Rules -->
        {% if yara_matches %}
            <div class="report-section">
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <h5 class="card-title mb-0">
                            <i data-feather="code" class="me-2"></i>
                            YARA Rule Analysis
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <h6>Rule Statistics</h6>
                                <ul class="list-unstyled">
                                    <li><strong>Rules Generated:</strong> {{ yara_matches.get('total_rules', 0) }}</li>
                                    <li><strong>Rules Matched:</strong> {{ yara_matches.get('match_count', 0) }}</li>
                                    <li><strong>Match Rate:</strong> 
                                        {% if yara_matches.get('total_rules', 0) > 0 %}
                                            {{ "%.1f"|format((yara_matches.get('match_count', 0) / yara_matches.get('total_rules', 1)) * 100) }}%
                                        {% else %}
                                            0%
                                        {% endif %}
                                    </li>
                                </ul>
                            </div>
                            
                            <div class="col-md-6">
                                <h6>Detection Confidence</h6>
                                <div class="progress mb-2" style="height: 25px;">
                                    {% set confidence = (yara_matches.get('match_count', 0) / yara_matches.get('total_rules', 1)) * 100 if yara_matches.get('total_rules', 0) > 0 else 0 %}
                                    <div class="progress-bar bg-{{ 'success' if confidence > 70 else 'warning' if confidence > 30 else 'danger' }}" 
                                         style="width: {{ confidence }}%">
                                        {{ "%.0f"|format(confidence) }}%
                                    </div>
                                </div>
                                <small class="text-muted">Based on YARA rule matches</small>
                            </div>
                        </div>
                        
                        {% if yara_matches.get('matched_rules') %}
                            <h6>Matched Rules</h6>
                            <div class="accordion" id="yaraAccordion">
                                {% for match in yara_matches.matched_rules[:5] %}
                                    <div class="accordion-item bg-dark">
                                        <h2 class="accordion-header">
                                            <button class="accordion-button collapsed bg-dark text-light" type="button" 
                                                    data-bs-toggle="collapse" data-bs-target="#yara{{ loop.index }}">
                                                <i data-feather="check-circle" class="text-success me-2" width="16" height="16"></i>
                                                {{ match.rule_name }}
                                            </button>
                                        </h2>
                                        <div id="yara{{ loop.index }}" class="accordion-collapse collapse" data-bs-parent="#yaraAccordion">
                                            <div class="accordion-body">
                                                {% if match.get('meta') and match.meta.get('description') %}
                                                    <p><strong>Description:</strong> {{ match.meta.description }}</p>
                                                {% endif %}
                                                {% if match.get('strings') %}
                                                    <p><strong>String Matches:</strong> {{ match.strings|length }}</p>
                                                    <div class="small">
                                                        {% for string in match.strings[:3] %}
                                                            <code class="d-block mb-1">{{ string.identifier }}: {{ string.instances }} instance(s)</code>
                                                        {% endfor %}
                                                    </div>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        {% endif %}

        <!-- Analysis Timeline -->
        <div class="report-section">
            <div class="card">
                <div class="card-header bg-secondary text-white">
                    <h5 class="card-title mb-0">
                        <i data-feather="clock" class="me-2"></i>
                        Analysis Timeline
                    </h5>
                </div>
                <div class="card-body">
                    <div class="timeline">
                        <div class="timeline-item">
                            <h6>File Upload</h6>
                            <p class="small text-muted mb-1">{{ job.created_at.strftime('%Y-%m-%d %H:%M:%S UTC') }}</p>
                            <p class="small mb-0">File uploaded and analysis initiated</p>
                        </div>
                        
                        {% if job.hybrid_job_id %}
                            <div class="timeline-item">
                                <h6>Sandbox Submission</h6>
                                <p class="small text-muted mb-1">Hybrid Analysis Job ID: {{ job.hybrid_job_id }}</p>
                                <p class="small mb-0">File submitted to sandbox environment</p>
                            </div>
                        {% endif %}
                        
                        {% if network_analysis %}
                            <div class="timeline-item">
                                <h6>Network Monitoring</h6>
                                <p class="small mb-0">Network traffic capture and analysis completed</p>
                            </div>
                        {% endif %}
                        
                        {% if yara_matches %}
                            <div class="timeline-item">
                                <h6>YARA Analysis</h6>
                                <p class="small mb-0">{{ yara_matches.get('total_rules', 0) }} rules generated, {{ yara_matches.get('match_count', 0) }} matches found</p>
                            </div>
                        {% endif %}
                        
                        <div class="timeline-item">
                            <h6>Report Generation</h6>
                            <p class="small text-muted mb-1">{{ job.updated_at.strftime('%Y-%m-%d %H:%M:%S UTC') }}</p>
                            <p class="small mb-0">Analysis completed and report generated</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recommendations -->
        <div class="report-section">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="card-title mb-0">
                        <i data-feather="shield" class="me-2"></i>
                        Security Recommendations
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="text-danger">Immediate Actions</h6>
                            <ul class="list-unstyled">
                                {% if sandbox_report and sandbox_report.get('verdict') in ['malicious', 'suspicious'] %}
                                    <li class="mb-2">
                                        <i data-feather="alert-triangle" class="text-danger me-2" width="16" height="16"></i>
                                        Quarantine and isolate affected systems
                                    </li>
                                    <li class="mb-2">
                                        <i data-feather="shield-off" class="text-danger me-2" width="16" height="16"></i>
                                        Block identified network indicators
                                    </li>
                                {% endif %}
                                <li class="mb-2">
                                    <i data-feather="search" class="text-warning me-2" width="16" height="16"></i>
                                    Scan environment for similar threats
                                </li>
                                <li class="mb-2">
                                    <i data-feather="users" class="text-info me-2" width="16" height="16"></i>
                                    Notify security team and stakeholders
                                </li>
                            </ul>
                        </div>
                        
                        <div class="col-md-6">
                            <h6 class="text-primary">Long-term Actions</h6>
                            <ul class="list-unstyled">
                                <li class="mb-2">
                                    <i data-feather="database" class="text-primary me-2" width="16" height="16"></i>
                                    Update threat intelligence feeds
                                </li>
                                <li class="mb-2">
                                    <i data-feather="settings" class="text-success me-2" width="16" height="16"></i>
                                    Review and update security policies
                                </li>
                                <li class="mb-2">
                                    <i data-feather="monitor" class="text-info me-2" width="16" height="16"></i>
                                    Enhance monitoring capabilities
                                </li>
                                <li class="mb-2">
                                    <i data-feather="book" class="text-secondary me-2" width="16" height="16"></i>
                                    Conduct security awareness training
                                </li>
                            </ul>
                        </div>
                    </div>
                    
                    <div class="alert alert-info mt-3">
                        <h6 class="alert-heading">
                            <i data-feather="info" class="me-2"></i>
                            Additional Resources
                        </h6>
                        <ul class="mb-0 small">
                            <li>Use extracted IOCs for threat hunting activities</li>
                            <li>Implement generated YARA rules in security tools</li>
                            <li>Cross-reference findings with external threat intelligence</li>
                            <li>Document incident response actions taken</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Report Footer -->
        <div class="report-section no-print">
            <div class="card border-secondary">
                <div class="card-body text-center">
                    <h6 class="text-muted mb-3">Report Generated</h6>
                    <p class="text-muted small mb-3">
                        This report was generated by BehaviorGuard v2.1 on 
                        {{ job.updated_at.strftime('%Y-%m-%d at %H:%M:%S UTC') }}
                    </p>
                    
                    <div class="btn-group mb-3">
                        <button onclick="window.print()" class="btn btn-outline-primary">
                            <i data-feather="printer" class="me-2"></i>
                            Print Report
                        </button>
                        {% if job.report_path %}
                            <a href="{{ url_for('analysis.download_report', job_id=job.id) }}" class="btn btn-outline-success">
                                <i data-feather="download" class="me-2"></i>
                                Download PDF
                            </a>
                        {% endif %}
                        <a href="{{ url_for('analysis.view_job', job_id=job.id) }}" class="btn btn-outline-secondary">
                            <i data-feather="arrow-left" class="me-2"></i>
                            Back to Analysis
                        </a>
                    </div>
                    
                    <div class="alert alert-warning">
                        <small>
                            <i data-feather="lock" class="me-2"></i>
                            <strong>Confidential:</strong> This report contains sensitive security information. 
                            Handle according to your organization's data classification policies.
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// Enhanced print functionality
window.addEventListener('beforeprint', function() {
    // Expand all accordions for printing
    document.querySelectorAll('.accordion-collapse').forEach(collapse => {
        collapse.classList.add('show');
    });
});

window.addEventListener('afterprint', function() {
    // Collapse accordions after printing
    document.querySelectorAll('.accordion-collapse').forEach(collapse => {
        collapse.classList.remove('show');
    });
});

// Copy IOC functionality
document.addEventListener('click', function(event) {
    if (event.target.closest('.copy-btn')) {
        const button = event.target.closest('.copy-btn');
        const iocText = button.nextElementSibling?.textContent || button.parentElement.textContent.replace('Copy', '').trim();
        
        navigator.clipboard.writeText(iocText).then(() => {
            const originalContent = button.innerHTML;
            button.innerHTML = '<i data-feather="check" width="12" height="12"></i>';
            button.classList.add('bg-success');
            
            setTimeout(() => {
                button.innerHTML = originalContent;
                button.classList.remove('bg-success');
                feather.replace();
            }, 2000);
            
            feather.replace();
        });
    }
});

// Auto-scroll to sections based on hash
if (window.location.hash) {
    const section = document.querySelector(window.location.hash);
    if (section) {
        section.scrollIntoView({ behavior: 'smooth' });
    }
}
</script>
{% endblock %}
